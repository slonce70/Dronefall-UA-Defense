# Dronefall: UA Defense

Реструктуризована офлайн‑версія Dronefall (Leaflet + Canvas): чистий код, UA‑локалізація, тести, поліпшений рендер і SW. Ідея та оригінал — https://www.dronefall.online

Локальна офлайн‑версія гри з картою Leaflet та Canvas‑рендером спрайтів. Документація та коментарі у коді — українською.

## Походження та застереження

Цей репозиторій — реструктуризація та оптимізація відкритої веб‑гри Dronefall (оригінал: https://www.dronefall.online/).
Ідея гри та початковий проєкт належать авторам оригіналу; ми не претендуємо на авторство ідеї.

У цьому форку виконано технічні поліпшення без зміни ідеї гри:

- спрощено й прискорено хіт‑тест (по альфа‑каналу базового PNG, без «масок» і воркерів);
- виправлено та покращено Service Worker (підтримка підшляхів, ігнор partial/Range);
- передзавантаження асетів із fallback, підключення CSS через `<link>` (менше «миготінь»);
- очищено та локалізовано коментарі (українська), спрощено структуру модулів;
- додано/підтримано тести (Vitest + Playwright) та CI.

## Структура

- `index.html` — точка входу; підключає Leaflet і `src/main.js`.
- `assets/` — зображення й аудіо гри (прямі шляхи `assets/*`).
- `public/` — статичні файли (service worker, маніфест, зовнішні залежності).
- `src/`
  - `main.js` — ініціалізація, геймлуп, запуск хвиль, інтеграція UI.
  - `constants.js` — карта, розклад хвиль, асети.
  - `utils.js` — передзавантаження картинок, bezier‑математика.
  - `audio.js` — звуковий індикатор атак.
  - `map.js` — хіт‑тест точки на карті (`isPointOnMap`).
  - `spawn.js` — вибір точок спавну та цілей.
  - `sprites.js` — рендер ворогів на `<canvas>` у панелі Leaflet.
  - `game/` — логіка хвиль і руху (`spawnWave.js`, `movement.js`, `waves.js`).
  - `pvo/` — економіка ППО (чисті функції) та типи (`pvo/math.js`, `pvo/data.js`).
- `tests/` — unit‑тести (Vitest) та e2e (Playwright).
- `scripts/` — службові скрипти (копіювання зовнішніх, оптимізація PNG).

## Команди

- `npm run dev` — запуск Vite dev‑сервера (`http://localhost:5173`).
- `npm run build` — збірка у `dist/` (ES2020, sourcemaps).
- `npm run preview` — локальний сервер для `dist/`.
- `npm run test` — юніт‑тести (Vitest, headless).
- `npm run e2e` — e2e‑тести (Playwright).
- `npm run lint` / `npm run format` — ESLint / Prettier.
- `npm run compress` — оптимізація PNG і генерація WebP для асетів.

### Тестовий режим

- Додайте `?test=1` до URL (наприклад, `http://localhost:5173/?test=1`) — перша хвиля стартує швидше (≈1.2с), а прелоадер тримається менше. Використовується в E2E.

### WebP і fallback

- У рантаймі гра пробує завантажувати WebP‑версії зображень (якщо підтримується браузером) і автоматично відкатується на оригінальні PNG/JPG у разі помилки. Предзавантаження (`preloadImages`) також враховує fallback.

### Service Worker і pre‑cache

- SW (`public/sw.js`) кешує статичні ресурси під час роботи (runtime) і під час встановлення завантажує список із `precache-manifest.json`, який генерується після збірки (`npm run build` + `postbuild`). Це прискорює перший офлайн‑запуск.

#### Автооновлення CACHE_NAME під час релізу

- Після збірки виконується `scripts/stamp-sw-cache.mjs`, який автоматично проставляє у `dist/sw.js` унікальне імʼя кеша виду `dronefall-runtime-v<версія>-<мітка>`. Значення береться з `package.json#version` і короткої часової мітки.
- Це гарантує «свіжий» кеш при кожному релізі без ручного редагування SW.
- Якщо потрібно форсувати інвалідацію кешу — підвищіть версію в `package.json` і побудуйте проєкт (`npm run build`).

## Асети

- Усі зображення/аудіо — в `assets/`. Маніфест (`public/manifest.webmanifest`) посилається на іконки з `assets/`.
- Предзавантаження зображень: `utils.js::preloadImages()` пробує `createImageBitmap()`, і за потреби переходить на `<img>`. Попередження `Bitmap preload failed, falling back: …` — очікуване і не є помилкою.

## Рендер і рух ворогів

- Спрайти малюються на `<canvas>` у власній панелі Leaflet — над мапою і під маркерами/попапами.
- Рух нормалізований за часом кадру (dt) у `src/game/movement.js`, тож швидкість стала на будь‑якому FPS.

## Запуск хвиль

- Перша хвиля стартує автоматично після запуску гри:
  - Таймер ≈1 сек після закриття стартового екрана.
  - Додатковий fail‑safe з ігрового циклу: якщо хвиля не стартувала сама, геймлуп запустить її після ~2 сек.
- Розклад затримок між хвилями — `src/constants.js::waveSchedule`.

## Вирішення проблем

1. Немає ворогів після старту:
   - Зачекайте 1–2 секунди — має початися хвиля 1 (у консолі з’явиться лог). Переконайтеся, що гра не на паузі (кнопка ▶️/⏸, пробіл).
   - Оновіть сторінку через «Empty cache and hard reload».
2. Не завантажуються зображення/іконки:
   - У dev переконайтеся, що SW відсутній (DevTools → Application → Service Workers). У проді SW є, але він не кешує 206 Partial Content.
   - Перевірте прямі URL `/assets/map.png`, `/assets/drone.png`, `/assets/explosion.gif`.

## Примітки

- Модулі — ESM (`type: module`). Документація та коментарі — українською.
- `dist/` і `node_modules/` не комітимо.

## Деталі реалізації (2025)

Архітектура й модулі

- `src/map/init.js`: ініціалізація Leaflet (CRS.Simple), ImageOverlay карти з `assets/map.png`, піксельний Canvas для хіт‑тесту.
- `src/sprites.js`: канвас спрайтів у панелі; плавний зум через CSS‑трансформ; на `zoomend` — один пересчіт.
- `src/game/movement.js`: єдиний оркестратор rAF (дрони/ракети/мобільне ППО), рух від dt.
- `src/ui/controls.js`: обробники швидкості/паузи та звуку, стан у localStorage.
- `src/ui/pvoMenu.js`: магазин/керування юнітами, ціни/апгрейди.
- `src/game/spawnWave.js`: спавн хвиль із різних боків.
- `src/beams.js` / `src/effects.js`: промені/вибухи з пулами обʼєктів.
- `src/utils.js`: WebP‑fallback, `preloadImages`, bezier‑утиліти.

Збірка та PWA

- CSS підʼєднується у `index.html` через `<link>`, що усуває «миготіння» в dev.
- Leaflet підʼєднано через npm та бандлиться Vite; `_externos` не використовується.
- Усі асети лежать у `public/assets` (пряма роздача `/assets/*`).
- `postbuild`: генерація `dist/precache-manifest.json` (використовується SW).
- `public/sw.js`: runtime‑кеш + pre‑cache; ігнорує partial (206) і Range‑запити.
- У dev SW автоматично відписується (див. `index.html`).

Тести/CI

- E2E використовують `?test=1` для пришвидшеного старту першої хвилі.
- GitHub Actions: лінт/юнити/E2E + артефакти (`playwright-report/`, `test-results/`).

Відладка

- Прапорці URL: `debug=points`, `debug=markers`, `debug=sprites`, `debug=canvas`, `pane=container`.
- Інспекція: `window.__stats` (останні спавни, лічильники), `window.__debug.spawnWave()`.

Що комітити

- Комітимо: `src/`, `assets/`, `public/`, `scripts/`, `tests/`, конфіги, `.github/`.
- Не комітимо: `dist/`, `node_modules/`, звіти/артефакти (`playwright-report/`, `test-results/`, `coverage/`).
- Великі асети бажано перевести на Git LFS (опційно).
